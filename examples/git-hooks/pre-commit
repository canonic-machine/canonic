#!/bin/bash
# CANONIC pre-commit hook: README regeneration trigger
# Detects changes to CANON.md or VOCABULARY.md and triggers README regeneration

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only)

# Check if CANON.md or VOCABULARY.md are being committed
CANON_CHANGED=false
VOCAB_CHANGED=false

for file in $STAGED_FILES; do
  if [[ "$file" == *"CANON.md" ]]; then
    CANON_CHANGED=true
  fi
  if [[ "$file" == *"VOCABULARY.md" ]]; then
    VOCAB_CHANGED=true
  fi
done

# If either governance file changed, trigger README regeneration
if [ "$CANON_CHANGED" = true ] || [ "$VOCAB_CHANGED" = true ]; then
  echo "üìù CANON or VOCABULARY changed - README regeneration required"
  echo ""
  echo "Self-documenting protocol triggered:"
  echo "  - CANON.md changed: $CANON_CHANGED"
  echo "  - VOCABULARY.md changed: $VOCAB_CHANGED"
  echo ""
  echo "Action required: Regenerate README.md before committing"
  echo ""
  echo "Options:"
  echo "  1. Run: generate-readme (if tool installed)"
  echo "  2. Manually update README.md to reflect changes"
  echo "  3. Stage README.md: git add README.md"
  echo ""

  # Check if README.md is also staged
  README_STAGED=false
  for file in $STAGED_FILES; do
    if [[ "$file" == *"README.md" ]]; then
      README_STAGED=true
    fi
  done

  if [ "$README_STAGED" = false ]; then
    echo "‚ùå README.md not staged - commit blocked"
    echo ""
    echo "Violation: Documentation protocol requires README.md regeneration"
    echo "when CANON.md or VOCABULARY.md changes."
    echo ""
    exit 1
  else
    echo "‚úÖ README.md staged - proceeding with commit"
    echo ""
  fi
fi

# Additional validation: Check README freshness via timestamps
# (This is a syntactic check - can be enhanced with semantic validation)

exit 0
