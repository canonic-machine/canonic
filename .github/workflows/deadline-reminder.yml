name: Deadline Reminder

on:
  schedule:
    # Run daily at 9am UTC
    - cron: '0 9 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-deadlines:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check Deadlines
        id: deadlines
        run: |
          TODAY=$(date +%Y-%m-%d)
          echo "Checking deadlines as of $TODAY"

          # Parse DEADLINES.md and check dates
          # This is a simple implementation - could be enhanced with Python

          DEADLINES_FILE="../companies/DEADLINES.md"

          if [ ! -f "$DEADLINES_FILE" ]; then
            echo "DEADLINES.md not found"
            exit 0
          fi

          # Extract deadline rows and check each
          ALERTS=""

          # DL-001: MammoChat Madrid Priority - 2026-04-13
          DEADLINE_001="2026-04-13"
          DAYS_UNTIL=$(( ($(date -d "$DEADLINE_001" +%s) - $(date -d "$TODAY" +%s)) / 86400 ))

          if [ $DAYS_UNTIL -le 0 ]; then
            ALERTS="$ALERTS\nüö® EXPIRED: MammoChat Madrid Priority window has closed!"
          elif [ $DAYS_UNTIL -le 7 ]; then
            ALERTS="$ALERTS\nüî¥ CRITICAL: MammoChat Madrid Priority expires in $DAYS_UNTIL days!"
          elif [ $DAYS_UNTIL -le 14 ]; then
            ALERTS="$ALERTS\nüü† URGENT: MammoChat Madrid Priority expires in $DAYS_UNTIL days!"
          elif [ $DAYS_UNTIL -le 30 ]; then
            ALERTS="$ALERTS\nüü° WARNING: MammoChat Madrid Priority expires in $DAYS_UNTIL days!"
          elif [ $DAYS_UNTIL -le 90 ]; then
            ALERTS="$ALERTS\n‚ÑπÔ∏è INFO: MammoChat Madrid Priority expires in $DAYS_UNTIL days"
          fi

          echo -e "$ALERTS"
          echo "alerts<<EOF" >> $GITHUB_OUTPUT
          echo -e "$ALERTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Issue if Critical
        if: contains(steps.deadlines.outputs.alerts, 'CRITICAL') || contains(steps.deadlines.outputs.alerts, 'URGENT') || contains(steps.deadlines.outputs.alerts, 'EXPIRED')
        uses: actions/github-script@v7
        with:
          script: |
            const alerts = `${{ steps.deadlines.outputs.alerts }}`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'deadline-alert',
              state: 'open'
            });

            const today = new Date().toISOString().split('T')[0];
            const title = `‚è∞ Deadline Alert - ${today}`;

            // Only create if no open deadline alert
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: `## Deadline Alerts\n\n${alerts}\n\n---\n\nSee [DEADLINES.md](../companies/DEADLINES.md) for full tracking.\n\n*Auto-generated by deadline-reminder workflow*`,
                labels: ['deadline-alert', 'ip-management']
              });
            }
