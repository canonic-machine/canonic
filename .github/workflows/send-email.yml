name: Send Email

on:
  push:
    paths:
      - '**/EMAIL-*.md'

jobs:
  send:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed email files
        id: changed
        run: |
          FILES=$(git diff --name-only HEAD~1 HEAD | grep 'EMAIL-.*\.md$' || true)
          echo "files=$FILES" >> $GITHUB_OUTPUT
          if [ -n "$FILES" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        if: steps.changed.outputs.found == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Send emails via Postmark
        if: steps.changed.outputs.found == 'true'
        env:
          POSTMARK_TOKEN: ${{ secrets.POSTMARK_TOKEN }}
          FROM_EMAIL: ${{ vars.FROM_EMAIL }}
        run: |
          for file in ${{ steps.changed.outputs.files }}; do
            echo "Processing: $file"

            # Extract To and Subject
            TO=$(grep -m1 "^\*\*To:\*\*" "$file" | sed 's/\*\*To:\*\* //' | tr -d '\r')
            SUBJECT=$(grep -m1 "^\*\*Subject:\*\*" "$file" | sed 's/\*\*Subject:\*\* //' | tr -d '\r')

            # Get body (everything after the first ---)
            BODY=$(awk '/^---$/{n++} n>=2' "$file" | tail -n +2)

            # Escape for JSON
            BODY_ESCAPED=$(echo "$BODY" | jq -Rs .)

            echo "To: $TO"
            echo "Subject: $SUBJECT"

            # Send via Postmark
            RESPONSE=$(curl -s -w "\n%{http_code}" "https://api.postmarkapp.com/email" \
              -X POST \
              -H "Accept: application/json" \
              -H "Content-Type: application/json" \
              -H "X-Postmark-Server-Token: $POSTMARK_TOKEN" \
              -d "{
                \"From\": \"$FROM_EMAIL\",
                \"To\": \"$TO\",
                \"Subject\": \"$SUBJECT\",
                \"TextBody\": $BODY_ESCAPED,
                \"MessageStream\": \"outbound\"
              }")

            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY_RESPONSE=$(echo "$RESPONSE" | head -n -1)

            if [ "$HTTP_CODE" = "200" ]; then
              echo "✓ Sent: $file -> $TO"
            else
              echo "✗ Failed: $file (HTTP $HTTP_CODE)"
              echo "$BODY_RESPONSE"
              exit 1
            fi
          done

      - name: Log delivery to git
        if: steps.changed.outputs.found == 'true'
        run: |
          mkdir -p .github/logs
          for file in ${{ steps.changed.outputs.files }}; do
            TO=$(grep -m1 "^\*\*To:\*\*" "$file" | sed 's/\*\*To:\*\* //' | tr -d '\r')
            echo "$(date -u +%Y-%m-%dT%H:%M:%SZ) | SENT | $file | $TO" >> .github/logs/email.log
          done
          git config user.name "CANONIC Bot"
          git config user.email "bot@canonic.dev"
          git add .github/logs/email.log
          git commit -m "EMAIL: delivery logged" || true
          git push || true
