#!/usr/bin/env bash
#
# CANONIC Pre-Push Gate (stack-aware)
#
# Git blocks push until:
#   1. LEDGER immutability holds
#   2. CANONIC validators pass (when available)
#   3. Remote secrets are configured (if GITHUB_TOKEN set)
#

set -e

echo "=== CANONIC Pre-Push Gate ==="

# =============================================================================
# LEDGER IMMUTABILITY ENFORCEMENT
# =============================================================================
# Rule: LEDGER_REWRITE_FORBIDDEN
# Rewriting REMOTE history is a governance violation.
# "Editing a draft is writing. Editing a record is fraud."
# =============================================================================

REMOTE_NAME="$1"
REMOTE_URL="$2"

while read -r local_ref local_sha remote_ref remote_sha; do
    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        continue
    fi

    if ! git merge-base --is-ancestor "$remote_sha" "$local_sha" 2>/dev/null; then
        case "$remote_ref" in
            refs/heads/main|refs/heads/master)
                echo ""
                echo "╔═══════════════════════════════════════════════════════════════╗"
                echo "║  LEDGER IMMUTABILITY VIOLATION DETECTED                       ║"
                echo "╠═══════════════════════════════════════════════════════════════╣"
                echo "║  Rule: LEDGER_REWRITE_FORBIDDEN                               ║"
                echo "║                                                               ║"
                echo "║  You are attempting to rewrite REMOTE history.                ║"
                echo "║  This is FORBIDDEN on protected branches (main/master).       ║"
                echo "║                                                               ║"
                echo "║  \"Editing a draft is writing. Editing a record is fraud.\"    ║"
                echo "║  \"LEDGER is the court record. Tampering is contempt.\"        ║"
                echo "║                                                               ║"
                echo "║  Branch: $remote_ref"
                echo "║  Remote SHA: $remote_sha"
                echo "║  Local SHA:  $local_sha"
                echo "╚═══════════════════════════════════════════════════════════════╝"
                echo ""
                echo "PUSH BLOCKED: LEDGER immutability enforced."
                echo ""
                echo "If you MUST rewrite history (rare, requires governance approval):"
                echo "  export CANONIC_ALLOW_REWRITE=1"
                echo "  git push --force"
                echo ""

                if [ "$CANONIC_ALLOW_REWRITE" = "1" ]; then
                    echo "WARNING: CANONIC_ALLOW_REWRITE=1 detected."
                    echo "Allowing force-push. This action is logged."
                    echo "You are responsible for this governance violation."
                    echo ""
                else
                    exit 1
                fi
                ;;
            *)
                echo "Note: Force-push to feature branch $remote_ref (allowed)"
                ;;
        esac
    fi
done

# =============================================================================
# CANONIC VALIDATORS
# =============================================================================

REPO_ROOT="$(git rev-parse --show-toplevel)"
HOOK_DIR="$(git rev-parse --git-path hooks)"

# =============================================================================
# CANONIC PURITY GUARD (IP DRIFT)
# =============================================================================

if [ "$(basename "$REPO_ROOT")" = "canonic" ] && [ -f "$REPO_ROOT/VOCAB.md" ]; then
    if grep -Eq '(IDF-|PA-|EP-|DISCLOSURE-|APPLICATION-|EPISODE-|Invention Disclosure)' "$REPO_ROOT/VOCAB.md"; then
        echo ""
        echo "[FAIL] IP drift detected in root VOCAB.md"
        echo "Move disclosure identifiers to PATENTS."
        exit 1
    fi
    for drift_dir in assets services publishing validators; do
        if [ -d "$REPO_ROOT/$drift_dir" ]; then
            echo ""
            echo "[FAIL] Drift detected: $drift_dir/ belongs outside canonic"
            exit 1
        fi
    done
    if find "$REPO_ROOT" -type d -name '.archive' -prune | grep -q .; then
        echo ""
        echo "[FAIL] Drift detected: .archive directories are forbidden"
        exit 1
    fi
fi

find_validators_root() {
    local search_dir="$REPO_ROOT"
    while [ "$search_dir" != "/" ]; do
        if [ -f "$search_dir/canonic/validators/validator_as_a_service.py" ]; then
            echo "$search_dir/canonic/validators"
            return 0
        fi
        if [ -f "$search_dir/validators/validator_as_a_service.py" ]; then
            echo "$search_dir/validators"
            return 0
        fi
        search_dir="$(dirname "$search_dir")"
    done
    return 1
}

VALIDATORS_ROOT="${CANONIC_VALIDATORS_ROOT:-$(find_validators_root || true)}"

# Block public validator implementations until PATENTS are filed.
PUBLIC_VALIDATOR_PATH="validators/validator_as_a_service.py"
if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    if git ls-files --error-unmatch "$PUBLIC_VALIDATOR_PATH" >/dev/null 2>&1; then
        if [ "${CANONIC_ALLOW_PUBLIC_VALIDATORS:-}" != "1" ]; then
            echo ""
            echo "[FAIL] Public validator implementation detected: ${PUBLIC_VALIDATOR_PATH}"
            echo "Push blocked until PATENTS are filed."
            echo "Remove ${PUBLIC_VALIDATOR_PATH} or set CANONIC_ALLOW_PUBLIC_VALIDATORS=1 to override."
            exit 1
        fi
    fi
fi

if command -v python3 >/dev/null 2>&1; then
    if [ -n "$VALIDATORS_ROOT" ] && [ -f "$VALIDATORS_ROOT/validator_as_a_service.py" ]; then
        echo "Running CANONIC validators..."
        python3 "$VALIDATORS_ROOT/validator_as_a_service.py" "$REPO_ROOT"
        EXIT_CODE=$?
        if [ $EXIT_CODE -ne 0 ]; then
            echo ""
            echo "[FAIL] CANONIC validation failed"
            echo "Push blocked. Fix violations before pushing."
            exit 1
        fi
        echo "CANONIC validators: PASS"
    else
        echo "Warning: validators not found, skipping CANONIC validation"
    fi
else
    echo "Warning: python3 not found, skipping CANONIC validation"
fi

# =============================================================================
# REMOTE SECRETS CHECK (OPTIONAL)
# =============================================================================

REMOTE="$1"
REMOTE_URL=$(git remote get-url "$REMOTE" 2>/dev/null || echo "")

if [[ "$REMOTE_URL" =~ github\.com[:/]([^/]+)/([^/.]+) ]]; then
    OWNER="${BASH_REMATCH[1]}"
    REPO="${BASH_REMATCH[2]}"

    echo "Remote: $OWNER/$REPO"

    if [ -n "$GITHUB_TOKEN" ]; then
        echo "Checking remote secrets..."

        SECRETS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$OWNER/$REPO/actions/secrets" | \
            grep -o '\"name\":\"[^\"]*\"' | sed 's/\"name\":\"//g' | tr -d '\"')

        MISSING=""
        for REQUIRED in GMAIL_USER GMAIL_APP_PASSWORD; do
            if ! echo "$SECRETS" | grep -q "^$REQUIRED$"; then
                MISSING="$MISSING $REQUIRED"
            fi
        done

        if [ -n "$MISSING" ]; then
            echo ""
            echo "[FAIL] Missing GitHub secrets:$MISSING"
            echo ""
            echo "Set these in: https://github.com/$OWNER/$REPO/settings/secrets/actions"
            echo ""
            echo "Push blocked. Remote gate not configured."
            exit 1
        fi

        echo "Remote secrets: OK"
    else
        echo "Warning: GITHUB_TOKEN not set, skipping remote check"
    fi
fi

# =============================================================================
# EMAIL VALIDATION (OPTIONAL)
# =============================================================================

EMAIL_VALIDATOR=""
if [ -n "$VALIDATORS_ROOT" ] && [ -f "$VALIDATORS_ROOT/email/validate.py" ]; then
    EMAIL_VALIDATOR="$VALIDATORS_ROOT/email/validate.py"
elif [ -f "$REPO_ROOT/validators/email/validate.py" ]; then
    EMAIL_VALIDATOR="$REPO_ROOT/validators/email/validate.py"
fi

FILES=$(git diff --name-only @{push}.. 2>/dev/null || git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
EMAIL_FILES=$(echo "$FILES" | grep 'EMAIL-.*\\.md$' || true)

if [ -n "$EMAIL_FILES" ]; then
    if [ -n "$EMAIL_VALIDATOR" ]; then
        echo "Validating email files..."
        for file in $EMAIL_FILES; do
            if [ -f "$file" ]; then
                python3 "$EMAIL_VALIDATOR" "$file"
            fi
        done
    else
        echo "Warning: email validator not found, skipping email checks"
    fi
fi

# Chain any local hook if present
LOCAL_HOOK="$HOOK_DIR/pre-push.local"
if [ -x "$LOCAL_HOOK" ]; then
    "$LOCAL_HOOK"
fi

echo "=== Gate PASSED ==="
