#!/usr/bin/env bash
#
# CANONIC pre-commit hook
# Runs validators and blocks IP drift in root governance.
#

set -e

REPO_ROOT="$(git rev-parse --show-toplevel)"

find_validators_root() {
    local search_dir="$REPO_ROOT"
    while [ "$search_dir" != "/" ]; do
        # Check for validators/canonic/ structure (CANONBASE layout)
        if [ -f "$search_dir/validators/canonic/validator_as_a_service.py" ]; then
            echo "$search_dir/validators/canonic"
            return 0
        fi
        # Check for canonic/validators/ structure (nested layout)
        if [ -f "$search_dir/canonic/validators/validator_as_a_service.py" ]; then
            echo "$search_dir/canonic/validators"
            return 0
        fi
        # Check for validators/ directly (flat layout)
        if [ -f "$search_dir/validators/validator_as_a_service.py" ]; then
            echo "$search_dir/validators"
            return 0
        fi
        search_dir="$(dirname "$search_dir")"
    done
    return 1
}

VALIDATORS_ROOT="${CANONIC_VALIDATORS_ROOT:-$(find_validators_root || true)}"

echo "=== CANONIC Pre-Commit Validation ==="

COMPLIANCE_LEVEL="${CANONIC_COMPLIANCE_LEVEL:-community}"
export CANONIC_COMPLIANCE_LEVEL="$COMPLIANCE_LEVEL"
echo "Compliance level: $COMPLIANCE_LEVEL"

echo "Checking root purity..."
if [ "$(basename "$REPO_ROOT")" = "canonic" ] && [ -f "$REPO_ROOT/VOCAB.md" ]; then
    if grep -Eq '(IDF-|PA-|EP-|DISCLOSURE-|APPLICATION-|EPISODE-|Invention Disclosure)' "$REPO_ROOT/VOCAB.md"; then
        echo ""
        echo "[FAIL] IP drift detected in root VOCAB.md"
        echo "Move disclosure identifiers to PATENTS."
        exit 1
    fi
fi
if [ "$(basename "$REPO_ROOT")" = "canonic" ]; then
    for drift_dir in assets services publishing validators; do
        if [ -d "$REPO_ROOT/$drift_dir" ]; then
            echo ""
            echo "[FAIL] Drift detected: $drift_dir/ belongs outside canonic"
            exit 1
        fi
    done
    if find "$REPO_ROOT" -type d -name '.archive' -prune | grep -q .; then
        echo ""
        echo "[FAIL] Drift detected: .archive directories are forbidden"
        exit 1
    fi
fi

echo "Running validators..."
if command -v python3 >/dev/null 2>&1; then
    if [ -n "$VALIDATORS_ROOT" ] && [ -f "$VALIDATORS_ROOT/validator_as_a_service.py" ]; then
        python3 "$VALIDATORS_ROOT/validator_as_a_service.py" "$REPO_ROOT"
        EXIT_CODE=$?
        if [ $EXIT_CODE -ne 0 ]; then
            echo ""
            echo "COMMIT BLOCKED: CANONIC validation failed"
            exit 1
        fi
    else
        echo "Warning: validators not found, skipping validation"
    fi
else
    echo "Warning: python3 not found, skipping validation"
fi

echo "COMMIT ALLOWED: All validations passed"
